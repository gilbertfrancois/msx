100 ' Flow
110 ' Gilbert Francois Duivesteijn
120 '
130 COLOR 15,1,1: CLS
140 ' setup perlin noise
150 NX=2: NY=8
160 OX=0: OY=0
170 NP=20: ' nr of particles
180 NC=3: ' nr of colors
190 NS=29: ' nr of steps
200 ST=5.3: ' step size
210 ' setup noise
220 GOSUB 16000
230 ' setup fast sin/cos
240 GOSUB 16820
250 ' setup particles
260 DIM PA(NP,2)
270 ' setup palette
280 DIM CO(NC)
290 CO(0)=4
300 CO(1)=5
310 CO(2)=7
320 CO(3)=14
330 ' init particles
340 FOR I=0 TO NP
350 GOSUB 1600
360 NEXT I
370 SCREEN 2
380 FC=0
390 ' update
400 FOR I=0 TO NP
410 IF PA(I,0)<1 OR PA(I,0)>254 GOTO 420 ELSE 430
420 GOSUB 1600
430 IF PA(I,1)<1 OR PA(I,1)>191 GOTO 440 ELSE 450
440 GOSUB 1600
450 X=PA(I,0)
460 Y=PA(I,1)
470 GOSUB 16460
480 TH=4*180*Z+180
490 IF TH<0 THEN TH=TH+360
500 PA(I,0)=PA(I,0)+ST*FN FC(TH)
510 PA(I,1)=PA(I,1)+ST*FN FS(TH)
520 CP=POINT(PA(I,0),PA(I,1)): ' prev color
530 CN=CO(INT(FC/NS*(NC))): 'new color
540 IF CN>CP GOTO 550 ELSE 560
550 PSET(PA(I,0),PA(I,1)),CN
560 NEXT I
570 FC=FC+1
580 IF FC>NS GOTO 590 ELSE 630
590 FOR I=0 TO NP
600 GOSUB 1600
610 NEXT I
620 FC=0
630 GOTO 390
1600 '
1610 ' init particle
1620 ' in: PA, I
1630 '
1640 PA(I,0)=INT(RND(1)*255)
1650 PA(I,1)=INT(RND(1)*191)
1660 RETURN
16000 ' libnoise
16010 ' Perlin noise generator
16020 ' Gilbert Francois Duivesteijn
16030 '
16040 ' init: 16000
16050 ' run: 16600
16060 '
16070 ' Init Perlin noise
16080 ' in: NX,NY: nr of cells
16090 '     OX,OY: offset in pxls
16100 ' out: GX,GY: grad in nodes
16110 '      PX,PY: pxls per cell
16120 '
16130 PRINT "[i] Generating random gradient."
16140 T0=TIME
16150 PX=(256-2*OX)/NX
16160 PY=(192-2*OY)/NY
16170 PRINT "[i] px: " + STR$(PX)
16180 PRINT "[i] py: " + STR$(PY)
16190 DIM GX(NX,NY): ' grad dv/dx
16200 DIM GY(NX,NY): ' grad dv/dy
16210 FOR I=0 TO NX
16220 FOR J=0 TO NY
16230 GX(I,J) = 2*RND(TIME)-1
16240 GY(I,J) = 2*RND(TIME)-1
16250 NEXT J
16260 NEXT I
16270 T1=TIME
16280 PRINT "    Done, " + STR$((T1-T0)/50) + " sec."
16290 RETURN
16300 '
16310 ' Dot gradient
16320 ' in:  x,ix,y,iy,gx,gy
16330 ' out: dg
16340 '
16350 DX=XP-IX
16360 DY=YP-IY
16370 DG=GX(IX,IY)*DX + GY(IX,IY)*DY
16380 RETURN
16390 '
16400 ' Interpolate
16410 ' in:  n0,n1,w
16420 ' out: n2
16430 '
16440 A2=(A1-A0)*W+A0
16450 RETURN
16460 '
16470 ' Perlin noise
16480 ' in: X, Y
16490 ' out: Z
16500 '
16510 XP=(X-OX)/PX
16520 YP=(Y-OY)/PY
16530 IX=INT(XP)
16540 IY=INT(YP)
16550 GOSUB 16300
16560 Z0=DG: DG=0
16570 IX=INT(XP)+1
16580 IY=INT(YP)
16590 GOSUB 16300
16600 Z1=DG: DG=0
16610 ' point(ix0,iy1)
16620 IX=INT(XP)
16630 IY=INT(YP)+1
16640 GOSUB 16300
16650 Z2=DG: DG=0
16660 ' point(ix1,iy1)
16670 IX=INT(XP)+1
16680 IY=INT(YP)+1
16690 GOSUB 16300
16700 Z3=DG: DG=0
16710 ' interpolate
16720 A0=Z0: A1=Z1: W=XP-INT(XP)
16730 GOSUB 16390
16740 Z4=A2: A2=0
16750 A0=Z2: A1=Z3: W=XP-INT(XP)
16760 GOSUB 16390
16770 Z5=A2: A2=0
16780 A0=Z4: A1=Z5: W=YP-INT(YP)
16790 GOSUB 16390
16800 Z=A2: A2=0
16810 RETURN
16820 ' libsin
16830 ' Library for fast goniometric
16840 ' functions.
16850 ' Gilbert Francois Duivesteijn
16860 '
16870 ' init: 18000
16880 ' run: fn fs(x)
16890 ' run: fn fc(x)
16900 PI=ATN(1)*4
16910 DIM TS(360): ' table sin
16920 PRINT "[i] Building lookup table..."
16930 ' Fast sin(x) function
16940 DEF FN FS(X)=TS((X+.5) MOD 360)
16950 ' Fast cos(x) function
16960 DEF FN FC(X)=TS((X+90.5) MOD 360)
16970 ' Create lookup table
16980 ' out: ts, fn fs, fn fc, pi
16990 FOR I=0 TO 359
17000 READ TS(I)
17010 NEXT I
17020 RETURN
17030 END
17040 DATA 0.000000000000000, 0.017452406437284
17050 DATA 0.034899496702501, 0.052335956242944
17060 DATA 0.069756473744125, 0.087155742747658
17070 DATA 0.104528463267653, 0.121869343405147
17080 DATA 0.139173100960065, 0.156434465040231
17090 DATA 0.173648177666930, 0.190808995376545
17100 DATA 0.207911690817759, 0.224951054343865
17110 DATA 0.241921895599668, 0.258819045102521
17120 DATA 0.275637355816999, 0.292371704722737
17130 DATA 0.309016994374947, 0.325568154457157
17140 DATA 0.342020143325669, 0.358367949545300
17150 DATA 0.374606593415912, 0.390731128489274
17160 DATA 0.406736643075800, 0.422618261740699
17170 DATA 0.438371146789077, 0.453990499739547
17180 DATA 0.469471562785891, 0.484809620246337
17190 DATA 0.500000000000000, 0.515038074910054
17200 DATA 0.529919264233205, 0.544639035015027
17210 DATA 0.559192903470747, 0.573576436351046
17220 DATA 0.587785252292473, 0.601815023152048
17230 DATA 0.615661475325658, 0.629320391049837
17240 DATA 0.642787609686539, 0.656059028990507
17250 DATA 0.669130606358858, 0.681998360062498
17260 DATA 0.694658370458997, 0.707106781186547
17270 DATA 0.719339800338651, 0.731353701619170
17280 DATA 0.743144825477394, 0.754709580222772
17290 DATA 0.766044443118978, 0.777145961456971
17300 DATA 0.788010753606722, 0.798635510047293
17310 DATA 0.809016994374947, 0.819152044288992
17320 DATA 0.829037572555042, 0.838670567945424
17330 DATA 0.848048096156426, 0.857167300702112
17340 DATA 0.866025403784439, 0.874619707139396
17350 DATA 0.882947592858927, 0.891006524188368
17360 DATA 0.898794046299167, 0.906307787036650
17370 DATA 0.913545457642601, 0.920504853452440
17380 DATA 0.927183854566787, 0.933580426497202
17390 DATA 0.939692620785908, 0.945518575599317
17400 DATA 0.951056516295154, 0.956304755963035
17410 DATA 0.961261695938319, 0.965925826289068
17420 DATA 0.970295726275996, 0.974370064785235
17430 DATA 0.978147600733806, 0.981627183447664
17440 DATA 0.984807753012208, 0.987688340595138
17450 DATA 0.990268068741570, 0.992546151641322
17460 DATA 0.994521895368273, 0.996194698091746
17470 DATA 0.997564050259824, 0.998629534754574
17480 DATA 0.999390827019096, 0.999847695156391
17490 DATA 1.000000000000000, 0.999847695156391
17500 DATA 0.999390827019096, 0.998629534754574
17510 DATA 0.997564050259824, 0.996194698091746
17520 DATA 0.994521895368273, 0.992546151641322
17530 DATA 0.990268068741570, 0.987688340595138
17540 DATA 0.984807753012208, 0.981627183447664
17550 DATA 0.978147600733806, 0.974370064785235
17560 DATA 0.970295726275996, 0.965925826289068
17570 DATA 0.961261695938319, 0.956304755963036
17580 DATA 0.951056516295154, 0.945518575599317
17590 DATA 0.939692620785908, 0.933580426497202
17600 DATA 0.927183854566787, 0.920504853452440
17610 DATA 0.913545457642601, 0.906307787036650
17620 DATA 0.898794046299167, 0.891006524188368
17630 DATA 0.882947592858927, 0.874619707139396
17640 DATA 0.866025403784439, 0.857167300702112
17650 DATA 0.848048096156426, 0.838670567945424
17660 DATA 0.829037572555042, 0.819152044288992
17670 DATA 0.809016994374947, 0.798635510047293
17680 DATA 0.788010753606722, 0.777145961456971
17690 DATA 0.766044443118978, 0.754709580222772
17700 DATA 0.743144825477394, 0.731353701619171
17710 DATA 0.719339800338651, 0.707106781186548
17720 DATA 0.694658370458997, 0.681998360062498
17730 DATA 0.669130606358858, 0.656059028990507
17740 DATA 0.642787609686539, 0.629320391049837
17750 DATA 0.615661475325658, 0.601815023152048
17760 DATA 0.587785252292473, 0.573576436351046
17770 DATA 0.559192903470747, 0.544639035015027
17780 DATA 0.529919264233205, 0.515038074910054
17790 DATA 0.500000000000000, 0.484809620246337
17800 DATA 0.469471562785891, 0.453990499739547
17810 DATA 0.438371146789077, 0.422618261740699
17820 DATA 0.406736643075800, 0.390731128489274
17830 DATA 0.374606593415912, 0.358367949545300
17840 DATA 0.342020143325669, 0.325568154457157
17850 DATA 0.309016994374948, 0.292371704722737
17860 DATA 0.275637355816999, 0.258819045102521
17870 DATA 0.241921895599668, 0.224951054343865
17880 DATA 0.207911690817759, 0.190808995376545
17890 DATA 0.173648177666930, 0.156434465040231
17900 DATA 0.139173100960065, 0.121869343405148
17910 DATA 0.104528463267654, 0.087155742747658
17920 DATA 0.069756473744126, 0.052335956242944
17930 DATA 0.034899496702501, 0.017452406437283
17940 DATA 0.000000000000000, -0.017452406437284
17950 DATA -0.034899496702501, -0.052335956242944
17960 DATA -0.069756473744125, -0.087155742747658
17970 DATA -0.104528463267653, -0.121869343405147
17980 DATA -0.139173100960066, -0.156434465040231
17990 DATA -0.173648177666930, -0.190808995376545
18000 DATA -0.207911690817760, -0.224951054343865
18010 DATA -0.241921895599668, -0.258819045102521
18020 DATA -0.275637355816999, -0.292371704722737
18030 DATA -0.309016994374947, -0.325568154457157
18040 DATA -0.342020143325669, -0.358367949545300
18050 DATA -0.374606593415912, -0.390731128489274
18060 DATA -0.406736643075800, -0.422618261740699
18070 DATA -0.438371146789077, -0.453990499739547
18080 DATA -0.469471562785891, -0.484809620246337
18090 DATA -0.500000000000000, -0.515038074910054
18100 DATA -0.529919264233205, -0.544639035015027
18110 DATA -0.559192903470747, -0.573576436351046
18120 DATA -0.587785252292473, -0.601815023152048
18130 DATA -0.615661475325658, -0.629320391049838
18140 DATA -0.642787609686539, -0.656059028990507
18150 DATA -0.669130606358858, -0.681998360062498
18160 DATA -0.694658370458997, -0.707106781186547
18170 DATA -0.719339800338651, -0.731353701619170
18180 DATA -0.743144825477394, -0.754709580222772
18190 DATA -0.766044443118978, -0.777145961456971
18200 DATA -0.788010753606722, -0.798635510047293
18210 DATA -0.809016994374947, -0.819152044288992
18220 DATA -0.829037572555042, -0.838670567945424
18230 DATA -0.848048096156426, -0.857167300702112
18240 DATA -0.866025403784438, -0.874619707139396
18250 DATA -0.882947592858927, -0.891006524188368
18260 DATA -0.898794046299167, -0.906307787036650
18270 DATA -0.913545457642601, -0.920504853452440
18280 DATA -0.927183854566787, -0.933580426497202
18290 DATA -0.939692620785908, -0.945518575599317
18300 DATA -0.951056516295154, -0.956304755963035
18310 DATA -0.961261695938319, -0.965925826289068
18320 DATA -0.970295726275996, -0.974370064785235
18330 DATA -0.978147600733806, -0.981627183447664
18340 DATA -0.984807753012208, -0.987688340595138
18350 DATA -0.990268068741570, -0.992546151641322
18360 DATA -0.994521895368273, -0.996194698091746
18370 DATA -0.997564050259824, -0.998629534754574
18380 DATA -0.999390827019096, -0.999847695156391
18390 DATA -1.000000000000000, -0.999847695156391
18400 DATA -0.999390827019096, -0.998629534754574
18410 DATA -0.997564050259824, -0.996194698091746
18420 DATA -0.994521895368273, -0.992546151641322
18430 DATA -0.990268068741570, -0.987688340595138
18440 DATA -0.984807753012208, -0.981627183447664
18450 DATA -0.978147600733806, -0.974370064785235
18460 DATA -0.970295726275997, -0.965925826289068
18470 DATA -0.961261695938319, -0.956304755963035
18480 DATA -0.951056516295154, -0.945518575599317
18490 DATA -0.939692620785908, -0.933580426497202
18500 DATA -0.927183854566787, -0.920504853452440
18510 DATA -0.913545457642601, -0.906307787036650
18520 DATA -0.898794046299167, -0.891006524188368
18530 DATA -0.882947592858927, -0.874619707139396
18540 DATA -0.866025403784439, -0.857167300702112
18550 DATA -0.848048096156426, -0.838670567945424
18560 DATA -0.829037572555042, -0.819152044288992
18570 DATA -0.809016994374948, -0.798635510047293
18580 DATA -0.788010753606722, -0.777145961456971
18590 DATA -0.766044443118978, -0.754709580222772
18600 DATA -0.743144825477395, -0.731353701619170
18610 DATA -0.719339800338651, -0.707106781186548
18620 DATA -0.694658370458998, -0.681998360062498
18630 DATA -0.669130606358858, -0.656059028990507
18640 DATA -0.642787609686540, -0.629320391049838
18650 DATA -0.615661475325658, -0.601815023152048
18660 DATA -0.587785252292473, -0.573576436351046
18670 DATA -0.559192903470747, -0.544639035015027
18680 DATA -0.529919264233205, -0.515038074910054
18690 DATA -0.500000000000000, -0.484809620246337
18700 DATA -0.469471562785891, -0.453990499739547
18710 DATA -0.438371146789078, -0.422618261740699
18720 DATA -0.406736643075800, -0.390731128489274
18730 DATA -0.374606593415912, -0.358367949545301
18740 DATA -0.342020143325669, -0.325568154457157
18750 DATA -0.309016994374948, -0.292371704722737
18760 DATA -0.275637355816999, -0.258819045102521
18770 DATA -0.241921895599668, -0.224951054343865
18780 DATA -0.207911690817760, -0.190808995376545
18790 DATA -0.173648177666930, -0.156434465040231
18800 DATA -0.139173100960066, -0.121869343405147
18810 DATA -0.104528463267653, -0.087155742747658
18820 DATA -0.069756473744126, -0.052335956242944
18830 DATA -0.034899496702501, -0.017452406437284
