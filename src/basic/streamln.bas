100 ' Stream lines
110 ' Gilbert Francois Duivesteijn
120 '
130 ' NOTE: It takes approximately
140 '       min 3 hours to render.
150 '
160 COLOR 1,15,15:CLS
170 SCREEN 2
180 NX=7: NY=5      ' nr of cells
190 OX=0: OY=0      ' offset
200 R=3             ' integr step
210 ST=12           ' grid step
220 SO=ST/2-1       ' step offset
230 PI=4*ATN(1)     ' Pi
240 DR=PI/180       ' DEG to RAD
250 RD=180/PI       ' RAD to DEG
260 GOSUB 16000
270 'GOSUB 630
280 T0=TIME
290 FOR XJ=SO TO 255-SO STEP ST
300 FOR YJ=SO TO 191-SO STEP ST
305 XI=RND(TIME)*255
306 YI=RND(TIME)*191
310 OA=0
320 GOSUB 440
330 OA=180
340 GOSUB 440
350 NEXT YJ
360 NEXT XJ
370 T1=TIME
380 BEEP
385 COLOR 1,15,14
390 IF INKEY$ <> " " THEN GOTO 390
400 SCREEN 0
410 PRINT "Elapsed time:"
420 PRINT STR$((T1-T0)/50) +" seconds."
430 END
440 '
450 ' Follow streamline
460 '
470 X0=XI: Y0=YI
480 FOR T=0 TO 300
490 X=X0: Y=Y0
500 IF X>255 OR X<0 THEN RETURN
510 IF Y>191 OR Y<0 THEN RETURN
520 GOSUB 16470
530 A=360*Z+OA
540 X1=X0+R*COS(A*DR)
550 Y1=Y0+R*SIN(A*DR)
560 LINE(X0,Y0)-(X1,Y1)
570 X0=X1: Y0=Y1
580 NEXT T
590 RETURN
600 '
610 ' Render dots
620 '
630 FOR XI=SO TO 255-SO STEP ST
640 FOR XI=SO TO 255-SO STEP ST
650 FOR YI=SO TO 191-SO STEP ST
660 PSET(XI,YI),14
670 NEXT YI
680 NEXT XI
690 RETURN
16000 '
16010 ' libnoise
16020 ' Perlin noise generator
16030 ' Gilbert Francois Duivesteijn
16040 '
16050 ' init: 16000
16060 ' run: 16600
16070 '
16080 ' Init Perlin noise
16090 ' in: NX,NY: nr of cells
16100 '     OX,OY: offset in pxls
16110 ' out: GX,GY: grad in nodes
16120 '      PX,PY: pxls per cell
16130 '
16140 PRINT "[i] Generating random gradient."
16150 T0=TIME
16160 PX=(256-2*OX)/NX
16170 PY=(192-2*OY)/NY
16180 PRINT "[i] px: " + STR$(PX)
16190 PRINT "[i] py: " + STR$(PY)
16200 DIM GX(NX,NY): ' grad dv/dx
16210 DIM GY(NX,NY): ' grad dv/dy
16220 FOR I=0 TO NX
16230 FOR J=0 TO NY
16240 GX(I,J) = 2*RND(1000)-1
16250 GY(I,J) = 2*RND(2000)-1
16260 NEXT J
16270 NEXT I
16280 T1=TIME
16290 PRINT "    Done, " + STR$((T1-T0)/50) + " sec."
16300 RETURN
16310 '
16320 ' Dot gradient
16330 ' in:  x,ix,y,iy,gx,gy
16340 ' out: dg
16350 '
16360 DX=XP-IX
16370 DY=YP-IY
16380 DG=GX(IX,IY)*DX + GY(IX,IY)*DY
16390 RETURN
16400 '
16410 ' Interpolate
16420 ' in:  n0,n1,w
16430 ' out: n2
16440 '
16450 A2=(A1-A0)*W+A0
16460 RETURN
16470 '
16480 ' Perlin noise
16490 ' in: X, Y
16500 ' out: Z
16510 '
16520 XP=(X-OX)/PX
16530 YP=(Y-OY)/PY
16540 IX=INT(XP)
16550 IY=INT(YP)
16560 GOSUB 16310
16570 Z0=DG: DG=0
16580 IX=INT(XP)+1
16590 IY=INT(YP)
16600 GOSUB 16310
16610 Z1=DG: DG=0
16620 ' point(ix0,iy1)
16630 IX=INT(XP)
16640 IY=INT(YP)+1
16650 GOSUB 16310
16660 Z2=DG: DG=0
16670 ' point(ix1,iy1)
16680 IX=INT(XP)+1
16690 IY=INT(YP)+1
16700 GOSUB 16310
16710 Z3=DG: DG=0
16720 ' interpolate
16730 A0=Z0: A1=Z1: W=XP-INT(XP)
16740 GOSUB 16400
16750 Z4=A2: A2=0
16760 A0=Z2: A1=Z3: W=XP-INT(XP)
16770 GOSUB 16400
16780 Z5=A2: A2=0
16790 A0=Z4: A1=Z5: W=YP-INT(YP)
16800 GOSUB 16400
16810 Z=A2: A2=0
16820 RETURN
